/**
 * Core Philosophy: This ruleset enforces a strict, two-tiered security model.
 * 1. User Ownership: Administrator profiles in `/admin_profiles` and user profiles
 *    in `/users` are private and can only be written by the owner of that profile.
 * 2. Role-Based Access: The existence of a document at `/roles_admin/{uid}` grants a user
 *    admin privileges. This allows for a simple and secure way to verify admin status.
 *
 * Data Structure:
 * - /admin_profiles/{adminId}: Contains the detailed profile data for a specific
 *   administrator, where `{adminId}` is their Firebase Auth UID.
 * - /roles_admin/{uid}: An empty document indicating a user has admin rights. Used for efficient rule checks.
 * - /users/{userId}: Contains public profile data for a specific user.
 * - /users/{userId}/bookings/{bookingId}: Lightweight copies of a user's bookings for their own access.
 * - /users/{userId}/favorites/{propertyId}: Stores a user's favorite properties.
 * - /users/{userId}/documents/{documentId}: Stores a user's uploaded documents.
 * - /users/{userId}/savedSearches/{searchId}: Stores a user's saved search filters.
 * - /bookings/{bookingId}: Contains complete booking details, accessible only by admins or the relevant vendor.
 * - /properties/{propertyId}: Contains property details.
 * - /visits/{visitId}: Contains visit request details.
 * - /announcements/{announcementId}: Contains system-wide announcements.
 *
 * Key Security Decisions:
 * - Admin Listing Disabled for Non-Admins: Non-administrative users cannot list
 *   or discover who the administrators or other users are.
 * - Self-Service Profile Management: Admins and Users are responsible for creating and
 *   maintaining their own profile data.
 * - Booking Ownership: Users can only manage bookings within their own user document path. The global collection is admin-only.
 * - Favorite Ownership: Users can only manage their own list of favorites.
 * - Document Ownership: Users can only manage their own documents.
 * - Saved Search Ownership: Users can only manage their own saved searches.
 * - Visit Ownership: Users can create visits. They can view their own visits.
 *   Property owners can view and manage visits for their properties.
 * - Announcement Management: Only admins can create, read, and manage announcements.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for readable and reusable logic
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks if the user is authenticated and has a verified email.
     */
    function isVerified() {
      return isSignedIn() && request.auth.token.email_verified == true;
    }

    /**
     * Checks if the requesting user's UID matches the document's owner ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the requesting user owns the document and the document already exists.
     * Crucial for preventing writes to non-existent paths on update/delete.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the requesting user is an administrator by verifying the
     * existence of a role document in the `/roles_admin` collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * Checks if the user is the owner of a given property.
     */
    function isPropertyOwner(propertyId) {
      let propertyDoc = get(/databases/$(database)/documents/properties/$(propertyId));
      return isSignedIn() && propertyDoc.data.owner.id == request.auth.uid;
    }

    /**
     * @description Manages individual user profiles and their subcollections.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if (isOwner(userId) || isAdmin()) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId) || isAdmin();
      
      /**
       * @description Manages a user's own lightweight booking records.
       * @path /users/{userId}/bookings/{bookingId}
       * @allow (read, write, delete) A user can only manage their own booking records.
       */
      match /bookings/{bookingId} {
        allow read, write, delete: if isVerified() && isOwner(userId);
      }

      /**
       * @description Manages a user's favorite properties.
       * @path /users/{userId}/favorites/{propertyId}
       */
      match /favorites/{propertyId} {
        allow read, write: if isVerified() && isOwner(userId);
      }
      
      /**
       * @description Manages a user's uploaded documents.
       * @path /users/{userId}/documents/{documentId}
       */
      match /documents/{documentId} {
        allow read, write, delete: if isVerified() && isOwner(userId);
      }
      
      /**
       * @description Manages a user's saved search filters.
       * @path /users/{userId}/savedSearches/{searchId}
       */
      match /savedSearches/{searchId} {
        allow read, write: if isVerified() && isOwner(userId);
      }
    }

    /**
     * @description Manages individual administrator profiles. Access is strictly limited to the profile owner.
     * @path /admin_profiles/{adminId}
     */
    match /admin_profiles/{adminId} {
      allow get: if isOwner(adminId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(adminId) && request.resource.data.id == adminId;
      allow update: if (isExistingOwner(adminId) || isAdmin()) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(adminId) || isAdmin();
    }
    
    /**
     * @description Manages admin role flags. Only other admins can grant/revoke admin status.
     * @path /roles_admin/{uid}
     */
    match /roles_admin/{uid} {
        allow read, write: if isAdmin();
    }
    
    /**
     * @description Manages the global bookings collection. This collection is for admin use, but vendors can list their own bookings.
     * @path /bookings/{bookingId}
     */
    match /bookings/{bookingId} {
      allow create: if isVerified() && isOwner(request.resource.data.userId);
      allow read: if isVerified() && (isOwner(resource.data.userId) || isOwner(resource.data.vendorId)) || isAdmin();
      allow list: if isAdmin() || (isVerified() && request.query.where[0][0] == 'vendorId' && request.query.where[0][2] == request.auth.uid);
      allow update: if (isVerified() && (isOwner(resource.data.userId) || isOwner(resource.data.vendorId))) || isAdmin();
      allow delete: if isAdmin() || (isVerified() && (isOwner(resource.data.userId) || isOwner(resource.data.vendorId)));
    }
    
    /**
     * @description Manages property listings.
     * @path /properties/{propertyId}
     */
    match /properties/{propertyId} {
      allow get: if (resource.data != null && resource.data.status == 'approved') || (isSignedIn() && (isAdmin() || isOwner(resource.data.owner.id)));
      allow list: if true;
      allow create: if isVerified() && isOwner(request.resource.data.owner.id) && request.resource.data.status == 'pending';
      allow update: if (isVerified() && resource.data != null && isOwner(resource.data.owner.id)) || isAdmin();
      allow delete: if (isVerified() && resource.data != null && isOwner(resource.data.owner.id)) || isAdmin();
    }
    
    /**
     * @description Manages visit requests for properties.
     * @path /visits/{visitId}
     */
    match /visits/{visitId} {
        allow create: if isVerified() && isOwner(request.resource.data.userId);
        allow read: if isVerified() && (isOwner(resource.data.userId) || isAdmin() || isPropertyOwner(resource.data.propertyId));
        allow list: if isVerified() && (isAdmin() || (request.query.where.size() > 0 && request.query.where[0][0] == 'userId' && request.query.where[0][2] == request.auth.uid) || (request.query.where.size() > 0 && request.query.where[0][0] == 'propertyId' && isPropertyOwner(request.query.where[0][2])));
        allow update: if (isVerified() && isPropertyOwner(resource.data.propertyId)) || isAdmin();
        allow delete: if (isVerified() && (isOwner(resource.data.userId) || isPropertyOwner(resource.data.propertyId))) || isAdmin();
    }

    /**
     * @description Manages global application settings.
     * @path /settings/global
     */
    match /settings/global {
      allow read, write: if isAdmin();
    }

    /**
     * @description Manages system-wide announcements.
     * @path /announcements/{announcementId}
     */
    match /announcements/{announcementId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Manages support tickets.
     * @path /tickets/{ticketId}
     */
    match /tickets/{ticketId} {
      allow create: if isSignedIn();
      allow read, write, list: if isAdmin();
    }
  }
}
